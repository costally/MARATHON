<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°í•˜ëŠ˜ ì‚¼ì¼ì ˆ í•˜í”„ë§ˆë¼í†¤ ë„ì „ : í›ˆë ¨ê³„íší‘œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <!-- Tailwind Configuration for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .chart-container { position: relative; width: 100%; height: 350px; }
        
        /* Custom Checkbox */
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Dark Mode Transitions */
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .dark .bg-white { background-color: #1e293b; border-color: #334155; }
        .dark .text-slate-900 { color: #f1f5f9; }
        .dark .text-slate-800 { color: #e2e8f0; }
        .dark .text-slate-600, .dark .text-slate-500 { color: #94a3b8; }
        .dark .bg-slate-50 { background-color: #334155; border-color: #475569; }
        .dark .border-slate-200 { border-color: #334155; }
        .dark select { background-color: #334155; color: white; border-color: #475569; }
        
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown Styles */
        .ai-content strong { color: #6366f1; font-weight: 700; }
        .dark .ai-content strong { color: #818cf8; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2rem; margin-top: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">

    <!-- Header & Nav -->
    <nav class="bg-white dark:bg-slate-900 shadow-lg sticky top-0 z-50 border-b dark:border-slate-800 transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & D-Day -->
                <div class="flex flex-col">
                    <h1 class="text-xl md:text-2xl font-black tracking-tight text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="text-indigo-600 dark:text-indigo-400">15 WEEKS</span> ARCHITECT
                    </h1>
                    <div id="dDayCounter" class="text-xs font-bold text-rose-500 bg-rose-50 dark:bg-rose-900/30 dark:text-rose-300 px-2 py-0.5 rounded w-fit mt-1">
                        D-DAY Loading...
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-3">
                    <button onclick="downloadICS()" class="hidden md:flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                        ğŸ“… <span>ìº˜ë¦°ë” ë‹´ê¸°</span>
                    </button>
                    <button id="themeToggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                        ğŸŒ™
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">

        <!-- SECTION 1: WEEKLY BLUEPRINT -->
        <section>
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        ğŸ“… ì£¼ê°„ ì‹¤í–‰ ê³„íš
                    </h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”. ì™„ë£Œ í›„ ì²´í¬ë°•ìŠ¤(âœ…)ë¥¼ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.
                    </p>
                </div>
                <div class="w-full md:w-64">
                    <select id="weekSelector" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none dark:bg-slate-800 transition">
                        <!-- Options via JS -->
                    </select>
                </div>
            </div>

            <!-- Phase Banner -->
            <div id="phaseBanner" class="w-full px-4 py-3 rounded-lg mb-6 text-center font-bold text-sm shadow-sm transition-all">
                <!-- Content via JS -->
            </div>

            <!-- Cards Grid -->
            <div id="dailyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Cards via JS -->
            </div>

            <!-- Detail Panel -->
            <div id="workoutDetailPanel" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-lg relative overflow-hidden transition-all">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500 transition-colors" id="detailAccent"></div>
                <div class="ml-2">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-2">
                                <span id="detailIcon">ğŸƒ</span>
                                <span id="detailTitle">í›ˆë ¨ ì œëª©</span>
                            </h3>
                            <span id="detailSpecs" class="inline-block px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded font-mono text-sm">
                                Specs Loading...
                            </span>
                        </div>
                        <button id="btnAskAI" class="group relative inline-flex items-center justify-center px-4 py-2 text-sm font-bold text-white transition-all duration-200 bg-indigo-600 font-pj rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600 hover:bg-indigo-700 shadow-md">
                            <span class="mr-2">âœ¨ AI ì½”ì¹˜ íŒ</span>
                            <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></div>
                        </button>
                    </div>

                    <!-- AI Response Area -->
                    <div id="aiCoachArea" class="hidden mb-8 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-slate-700 dark:to-slate-800 border border-indigo-100 dark:border-slate-600 rounded-xl p-5 relative shadow-inner">
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-indigo-100 dark:border-slate-600">
                            <span class="text-xl">ğŸ¤–</span>
                            <h4 class="font-bold text-indigo-900 dark:text-indigo-300 text-sm">Gemini AI Coach's Analysis</h4>
                        </div>
                        <div id="aiLoading" class="hidden flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400 py-4">
                            <div class="loader"></div>
                            <span>ë°°í•˜ëŠ˜ ë‹˜ì˜ ì‹ ì²´ ë°ì´í„°ì™€ í›ˆë ¨ ëª©í‘œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
                        </div>
                        <div id="aiContent" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed ai-content space-y-2"></div>
                        <button id="closeAi" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- 3 Column Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">ğŸ¯ WHY (ëª©ì )</h4>
                            <p id="detailWhy" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">...</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">âš™ï¸ HOW (ì‹¤í–‰)</h4>
                            <p id="detailHow" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">...</p>
                        </div>
                        <div class="bg-rose-50 dark:bg-rose-900/20 p-5 rounded-xl border border-rose-100 dark:border-rose-900/50">
                            <h4 class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mb-3">âš ï¸ CAUTION (ì£¼ì˜)</h4>
                            <p id="detailCaution" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: SAFETY PROTOCOL -->
        <section>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        ğŸ›¡ï¸ í†µì¦ ì‹ í˜¸ë“± <span class="text-xs font-normal text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">Gemini Protocol</span>
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-rose-50 dark:bg-rose-900/20 p-4 rounded-lg border-l-4 border-rose-500">
                        <span class="block font-bold text-rose-700 dark:text-rose-400 mb-1 text-sm">ğŸ”´ RED (ì¦‰ì‹œ ì¤‘ë‹¨)</span>
                        <span class="text-xs text-slate-600 dark:text-slate-400">ì°Œë¥´ëŠ” ë“¯í•œ êµ­ì†Œ í†µì¦, ì•„ì¹¨ ì²«ë°œ í†µì¦. 48ì‹œê°„ íœ´ì‹ í•„ìˆ˜.</span>
                    </div>
                    <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg border-l-4 border-amber-500">
                        <span class="block font-bold text-amber-700 dark:text-amber-400 mb-1 text-sm">ğŸŸ¡ YELLOW (ê°•ë„ ì¡°ì ˆ)</span>
                        <span class="text-xs text-slate-600 dark:text-slate-400">ë¬µì§í•œ ë­‰ì¹¨, ë»£ë»£í•¨. ê±°ë¦¬ ë‹¨ì¶• ë° ë§ˆì‚¬ì§€ ê°•í™”.</span>
                    </div>
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg border-l-4 border-emerald-500">
                        <span class="block font-bold text-emerald-700 dark:text-emerald-400 mb-1 text-sm">ğŸŸ¢ GREEN (ì •ìƒ ì§„í–‰)</span>
                        <span class="text-xs text-slate-600 dark:text-slate-400">í†µì¦ ì—†ìŒ, ê°œìš´í•¨. ê³„íšëŒ€ë¡œ í›ˆë ¨ ì§„í–‰.</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: ANALYTICS -->
        <section>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Chart -->
                <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">ğŸ“Š 15ì£¼ í›ˆë ¨ ë¡œë“œë§µ</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">LSD ê±°ë¦¬(ë§‰ëŒ€)ì™€ ì—…í ê°•ë„(ì„ )ì˜ ë³€í™” ì¶”ì´</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="comboChart"></canvas>
                    </div>
                </div>
                
                <!-- Fixed Schedule Summary -->
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">ğŸ—“ï¸ ê³ ì • ìŠ¤ì¼€ì¤„ (Routine)</h3>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-500 dark:text-slate-400 w-8">MON</span>
                                <span class="font-medium text-slate-800 dark:text-slate-200">ë¦¬ì»¤ë²„ë¦¬ (Recovery)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 opacity-50">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-400 w-8">TUE</span>
                                <span class="font-medium text-slate-500">íœ´ì‹ (Rest)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg bg-cyan-50 dark:bg-cyan-900/20">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-cyan-600 dark:text-cyan-400 w-8">WED</span>
                                <span class="font-medium text-cyan-900 dark:text-cyan-200">í¬ë£¨ëŸ° (Crew Run)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 opacity-50">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-400 w-8">THU</span>
                                <span class="font-medium text-slate-500">íœ´ì‹ (Rest)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-indigo-600 dark:text-indigo-400 w-8">FRI</span>
                                <span class="font-medium text-indigo-900 dark:text-indigo-200">ì—…í (Uphill)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-emerald-600 dark:text-emerald-400 w-8">SAT</span>
                                <span class="font-medium text-emerald-900 dark:text-emerald-200">ì‰ì´í¬ì•„ì›ƒ (Easy)</span>
                            </div>
                        </li>
                        <li class="flex items-center justify-between p-3 rounded-lg bg-rose-50 dark:bg-rose-900/20 border-l-4 border-rose-500">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-rose-600 dark:text-rose-400 w-8">SUN</span>
                                <span class="font-medium text-rose-900 dark:text-rose-200">LSD (Long Run)</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-10 mt-12 border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="font-mono text-sm tracking-wider">ENGINEERED BY GPT & GEMINI</p>
            <p class="text-xs mt-2 text-slate-600">Ultimate Edition for Bae Haneul</p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // --- CONSTANTS ---
        const API_KEY = ""; // Provided by Environment
        const STORAGE_KEY = "running_app_data_v1";
        const START_DATE = "2025-11-17";
        const RACE_DATE = "2026-02-23"; // Updated based on 15 weeks

        // --- THEME LOGIC ---
        const themeToggle = document.getElementById('themeToggle');
        const htmlEl = document.documentElement;
        
        // Init Theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlEl.classList.add('dark');
            themeToggle.textContent = 'â˜€ï¸';
        } else {
            htmlEl.classList.remove('dark');
            themeToggle.textContent = 'ğŸŒ™';
        }

        themeToggle.addEventListener('click', () => {
            htmlEl.classList.toggle('dark');
            if (htmlEl.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
            }
            // Re-render chart for dark mode colors
            if(window.myChart) window.myChart.update();
        });

        // --- STORAGE LOGIC ---
        function getStorageData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }
        function saveCompletion(dateStr, isCompleted) {
            const data = getStorageData();
            if (!data[dateStr]) data[dateStr] = {};
            data[dateStr].completed = isCompleted;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            // Trigger visual update if needed immediately, or handle via UI state
        }

        // --- WORKOUT LIBRARY (Content) ---
        const workoutLibrary = {
            "ë¦¬ì»¤ë²„ë¦¬": { why: "ì¼ìš”ì¼ LSDì˜ í”¼ë¡œ(ì –ì‚°) ì œê±° ë° ê·¼ìœ¡ ì´ì™„. ì™„ì „ íœ´ì‹ë³´ë‹¤ íšŒë³µ ì†ë„ ë¹ ë¦„.", how: "ëŒ€í™”ê°€ ê°€ëŠ¥í•œ ì•„ì£¼ ëŠë¦° ì†ë„(Zone 1-2). í¼ ìœ ì§€ì—ë§Œ ì§‘ì¤‘.", caution: "ì†ë„ ìš•ì‹¬ ê¸ˆì§€. ìš´ë™ì´ ì•ˆ ë˜ëŠ” ëŠë‚Œì´ ë“¤ì–´ì•¼ ì •ìƒ." },
            "íœ´ì‹": { why: "ê·¼ìœ¡/ì‹ ê²½ê³„ ì„±ì¥ ë° ì—ë„ˆì§€ ì¶©ì „. ë‹¤ìŒ ë‚  ê³ ê°•ë„ í›ˆë ¨ ì¤€ë¹„.", how: "ì™„ì „ íœ´ì‹ ë˜ëŠ” ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­. ìˆ˜ë©´ ì‹œê°„ í™•ë³´.", caution: "í•˜ì²´ ê·¼ë ¥ ìš´ë™ ìì œ. ì™„ì „í•œ ë¹„ì›€ í•„ìš”." },
            "í¬ë£¨ëŸ°": { why: "ëŸ¬ë‹ì˜ ì¦ê±°ì›€ ìœ ì§€ ë° ì‚¬íšŒì  ì†Œì†ê°. ë©˜íƒˆ ë¦¬í”„ë ˆì‹œ.", how: "ë™ë£Œë“¤ê³¼ ëŒ€í™”í•˜ë©° ì¦ê²ê²Œ ëŸ¬ë‹. í¸ì•ˆí•œ ê·¸ë£¹ í˜ì´ìŠ¤ ìœ ì§€.", caution: "ë¶„ìœ„ê¸°ì— íœ©ì“¸ë ¤ ì˜¤ë²„í˜ì´ìŠ¤ ê¸ˆì§€. í…œí¬ëŸ° ì•„ë‹˜." },
            "ì‰ì´í¬ì•„ì›ƒ": { why: "ê¸ˆìš”ì¼ ì—…í ë…ì†Œ ì œê±° ë° ì¼ìš”ì¼ LSD ì˜ˆì—´. ì „ëµì  íœ´ì‹.", how: "3~5km ì•„ì£¼ ê°€ë³ê²Œ ì¡°ê¹…. 'ë” ë›°ê³  ì‹¶ë‹¤' ì‹¶ì„ ë•Œ ë©ˆì¶¤.", caution: "ëª¸ì´ ë¬´ê±°ìš°ë©´ ê³¼ê°íˆ ì™„ì „ íœ´ì‹ ì „í™˜ ê°€ëŠ¥." },
            "ì—…í": { why: "ì‹¬íì§€êµ¬ë ¥(VO2max) ë° í•˜ì²´ ê·¼ë ¥ ë™ì‹œ ê°•í™”. ê´€ì ˆ ì¶©ê²© ìµœì†Œí™”.", how: "ì˜¤ë¥´ë§‰: ì¢ì€ ë³´í­, ì—‰ë©ì´ ì‚¬ìš©. ë‚´ë¦¬ë§‰: ë°˜ë“œì‹œ ê±·ê¸°.", caution: "ë‚´ë¦¬ë§‰ ë›°ê¸° ì ˆëŒ€ ê¸ˆì§€ (ë¬´ë¦/ì•„í‚¬ë ˆìŠ¤ê±´ ì¶©ê²© ìœ„í—˜)." },
            "LSD": { why: "ì§€ë°© ëŒ€ì‚¬ ëŠ¥ë ¥ ë° ì¥ê±°ë¦¬ ì£¼í–‰ íš¨ìœ¨ì„±(Economy) ê°•í™”.", how: "ì¼ì •í•œ ì €ê°•ë„ í˜ì´ìŠ¤ ìœ ì§€. ê±°ë¦¬/ì‹œê°„ ì±„ìš°ê¸°ê°€ ëª©í‘œ.", caution: "ì¤‘ê°„ ê¸‰ìˆ˜ í•„ìˆ˜. ì´ˆë°˜ ì˜¤ë²„í˜ì´ìŠ¤ ì‹œ í›„ë°˜ì— í¼ì§." }
        };

        // --- DATA ---
        const trainingData = [
            { week: 1, date: "2025-11-17", phase: "ì ì‘ê¸° (Base)", note: "ê±°ë¦¬ ì ì‘ ì‹œì‘", lsdDist: 14.00, lsdPace: "6:30", tempoDist: 4.00, tempoPace: "5:30", uphillSets: 8, uphillPace: "4:40" },
            { week: 2, date: "2025-11-24", phase: "ì ì‘ê¸° (Base)", note: "LSD ê±°ë¦¬ ì¦ê°€", lsdDist: 15.40, lsdPace: "6:30", tempoDist: 4.28, tempoPace: "5:25", uphillSets: 9, uphillPace: "4:38" },
            { week: 3, date: "2025-12-01", phase: "ì ì‘ê¸° (Base)", note: "ê¸°ì´ˆ ì²´ë ¥ í™•ë³´", lsdDist: 16.94, lsdPace: "6:30", tempoDist: 4.58, tempoPace: "5:20", uphillSets: 10, uphillPace: "4:36" },
            { week: 4, date: "2025-12-08", phase: "íšŒë³µì£¼ (Recovery)", note: "ê°•ë„ ì¡°ì ˆ", lsdDist: 11.86, lsdPace: "6:30", tempoDist: 3.21, tempoPace: "5:30", uphillSets: 7, uphillPace: "4:34" },
            { week: 5, date: "2025-12-15", phase: "ê°•í™”ê¸° (Build)", note: "ë‹¤ì‹œ ê±°ë¦¬ ì¦ê°€", lsdDist: 16.94, lsdPace: "6:30", tempoDist: 4.58, tempoPace: "5:20", uphillSets: 10, uphillPace: "4:36" },
            { week: 6, date: "2025-12-22", phase: "ê°•í™”ê¸° (Build)", note: "ì—…í ì„¸íŠ¸ ì¦ê°€", lsdDist: 18.63, lsdPace: "6:30", tempoDist: 4.90, tempoPace: "5:15", uphillSets: 11, uphillPace: "4:34" },
            { week: 7, date: "2025-12-29", phase: "ê°•í™”ê¸° (Build)", note: "20k ëŒíŒŒ", lsdDist: 20.50, lsdPace: "6:30", tempoDist: 5.24, tempoPace: "5:10", uphillSets: 12, uphillPace: "4:32" },
            { week: 8, date: "2026-01-05", phase: "íšŒë³µì£¼ (Recovery)", note: "ì¤‘ê°„ íœ´ì‹", lsdDist: 14.35, lsdPace: "6:30", tempoDist: 4.19, tempoPace: "5:20", uphillSets: 7, uphillPace: "4:30" },
            { week: 9, date: "2026-01-12", phase: "ê°•í™”ê¸° (Peak Prep)", note: "ê³ ê°•ë„ ì§€ì†", lsdDist: 20.50, lsdPace: "6:30", tempoDist: 5.24, tempoPace: "5:10", uphillSets: 12, uphillPace: "4:32" },
            { week: 10, date: "2026-01-19", phase: "ê°•í™”ê¸° (Peak)", note: "ìµœëŒ€ ë¶€í•˜ ì§„ì…", lsdDist: 22.55, lsdPace: "6:30", tempoDist: 5.61, tempoPace: "5:05", uphillSets: 13, uphillPace: "4:30" },
            { week: 11, date: "2026-01-26", phase: "ê°•í™”ê¸° (Max Peak)", note: "ìµœì¥ ê±°ë¦¬ LSD", lsdDist: 24.80, lsdPace: "6:30", tempoDist: 6.00, tempoPace: "5:00", uphillSets: 14, uphillPace: "4:28" },
            { week: 12, date: "2026-02-02", phase: "ì¡°ì ˆê¸° (Taper)", note: "í›ˆë ¨ëŸ‰ ê°ì†Œ ì‹œì‘", lsdDist: 17.36, lsdPace: "6:30", tempoDist: 4.80, tempoPace: "5:10", uphillSets: 9, uphillPace: "4:26" },
            { week: 13, date: "2026-02-09", phase: "ì‹¤ì „ê¸° (Race Prep)", note: "í˜ì´ìŠ¤ ê°ê° ìœ ì§€", lsdDist: 19.84, lsdPace: "6:30", tempoDist: 4.80, tempoPace: "5:00", uphillSets: 11, uphillPace: "4:28" },
            { week: 14, date: "2026-02-16", phase: "ì¡°ì ˆê¸° (Taper)", note: "ê¸‰ê²©í•œ ì–‘ ê°ì†Œ", lsdDist: 14.88, lsdPace: "6:30", tempoDist: 3.60, tempoPace: "5:10", uphillSets: 9, uphillPace: "4:26" },
            { week: 15, date: "2026-02-23", phase: "ëŒ€íšŒì£¼ (Race Week)", note: "ì»¨ë””ì…˜ ìµœì í™”", lsdDist: 7.44, lsdPace: "6:30", tempoDist: 1.80, tempoPace: "5:00", uphillSets: 4, uphillPace: "4:28" }
        ];

        // --- HELPER: D-DAY & DATES ---
        function updateDDay() {
            const today = new Date();
            const raceDay = new Date(RACE_DATE);
            const diff = raceDay - today;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            
            const el = document.getElementById('dDayCounter');
            if(days > 0) el.textContent = `D-${days} to RACE`;
            else if(days === 0) el.textContent = `D-DAY! GO!`;
            else el.textContent = `Race Finished`;
        }
        updateDDay();

        function getWeekDates(startDateStr) {
            const startDate = new Date(startDateStr);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const m = d.getMonth() + 1;
                const day = d.getDate();
                // ISO string for storage key (YYYY-MM-DD)
                const iso = d.toISOString().split('T')[0];
                dates.push({ display: `${m}.${day}`, iso: iso, obj: d });
            }
            return dates;
        }

        // --- RENDER LOGIC ---
        const weekSelector = document.getElementById('weekSelector');
        const phaseBanner = document.getElementById('phaseBanner');
        const dailyGrid = document.getElementById('dailyGrid');
        const detailPanel = document.getElementById('workoutDetailPanel');
        
        let currentAiContext = {};

        // Populate Dropdown
        trainingData.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.week;
            opt.text = `Week ${d.week} (${d.date})`;
            weekSelector.appendChild(opt);
        });

        function renderWeek(weekNum) {
            const data = trainingData.find(d => d.week == weekNum);
            const dates = getWeekDates(data.date);
            const todayIso = new Date().toISOString().split('T')[0];
            const savedData = getStorageData();

            // Phase Banner Style
            phaseBanner.textContent = `Week ${data.week} [${data.phase}] - ${data.note}`;
            let bannerClass = "w-full px-4 py-3 rounded-lg mb-6 text-center font-bold text-sm shadow-sm border ";
            if (data.phase.includes('íšŒë³µ') || data.phase.includes('ì¡°ì ˆ')) bannerClass += "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600";
            else if (data.week === 15) bannerClass += "bg-rose-100 dark:bg-rose-900/40 text-rose-800 dark:text-rose-200 border-rose-200 dark:border-rose-800";
            else bannerClass += "bg-indigo-100 dark:bg-indigo-900/40 text-indigo-800 dark:text-indigo-200 border-indigo-200 dark:border-indigo-800";
            phaseBanner.className = bannerClass;

            dailyGrid.innerHTML = '';

            // Schedule Data (Strategic Cut: Tue/Thu Rest, Sat Shakeout)
            const schedule = [
                { day: "ì›”", type: "ë¦¬ì»¤ë²„ë¦¬", icon: "ğŸ›Œ", work: `íšŒë³µ ì¡°ê¹… 5km`, detail: `Pace 7:00`, safety: "í”¼ë¡œ íšŒë³µ" },
                { day: "í™”", type: "íœ´ì‹", icon: "ğŸ§˜", work: "ì™„ì „ íœ´ì‹", detail: "ìŠ¤íŠ¸ë ˆì¹­", safety: "ì¬ì¶©ì „" },
                { day: "ìˆ˜", type: "í¬ë£¨ëŸ°", icon: "ğŸƒâ€â™‚ï¸", work: "í¬ë£¨ ëŸ¬ë‹", detail: "ì¦ê±°ìš´ í˜ì´ìŠ¤", safety: "ì˜¤ë²„í˜ì´ìŠ¤ X" },
                { day: "ëª©", type: "íœ´ì‹", icon: "ğŸ§˜", work: "ì™„ì „ íœ´ì‹", detail: "ìˆ˜ë©´ í™•ë³´", safety: "ì—…í ëŒ€ë¹„" },
                { day: "ê¸ˆ", type: "ì—…í", icon: "â›°ï¸", work: `ì—…í ${data.uphillSets}ì„¸íŠ¸`, detail: `Pace ${data.uphillPace}`, safety: "ë‚´ë¦¬ë§‰ ê±·ê¸°" },
                { day: "í† ", type: "ì‰ì´í¬ì•„ì›ƒ", icon: "ğŸƒ", work: "ê°€ë²¼ìš´ ì¡°ê¹… 3~5km", detail: "í¸ì•ˆí•˜ê²Œ", safety: "LSD ì˜ˆì—´" },
                { day: "ì¼", type: "LSD", icon: "ğŸ›£ï¸", work: `ì¥ê±°ë¦¬ì£¼ ${data.lsdDist}km`, detail: `Pace ${data.lsdPace}`, safety: "ì¤‘ê°„ ê¸‰ìˆ˜" }
            ];

            let defaultCardToClick = null;

            schedule.forEach((item, index) => {
                const dateInfo = dates[index];
                const isToday = (dateInfo.iso === todayIso);
                const isCompleted = savedData[dateInfo.iso]?.completed || false;

                // Card Container
                const card = document.createElement('div');
                let cardClass = "relative rounded-xl p-4 shadow-sm border transition-all duration-200 cursor-pointer group ";
                
                // Styles based on state
                if (isToday) {
                    cardClass += "bg-white dark:bg-slate-800 ring-2 ring-indigo-500 border-transparent shadow-md scale-[1.02] z-10 ";
                } else if (isCompleted) {
                    cardClass += "bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-800 opacity-70 hover:opacity-100 ";
                } else {
                    cardClass += "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:shadow-md hover:-translate-y-1 ";
                }
                card.className = cardClass;

                // Content
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs font-bold ${isToday ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400'}">${dateInfo.display} (${item.day})</span>
                            ${isToday ? '<span class="ml-2 text-[10px] bg-indigo-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">TODAY</span>' : ''}
                        </div>
                        <!-- Checkbox Wrapper -->
                        <div class="checkbox-wrapper relative z-20" onclick="event.stopPropagation()">
                            <label class="cursor-pointer flex items-center">
                                <input type="checkbox" class="peer sr-only" ${isCompleted ? 'checked' : ''} onchange="toggleComplete('${dateInfo.iso}', this)">
                                <div class="w-6 h-6 border-2 border-slate-300 dark:border-slate-600 rounded flex items-center justify-center peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition-colors">
                                    <svg class="w-3.5 h-3.5 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-lg">${item.icon}</span>
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm">${item.type}</h4>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 truncate">${item.work}</p>
                    <div class="pt-2 border-t border-dashed border-slate-100 dark:border-slate-700 mt-auto">
                        <span class="text-[10px] font-mono bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded">${item.detail}</span>
                    </div>
                `;

                // Click Logic (Detail)
                card.onclick = () => {
                    // Visual Select
                    document.querySelectorAll('#dailyGrid > div').forEach(c => {
                        c.classList.remove('ring-2', 'ring-indigo-500');
                        if (!c.innerHTML.includes('TODAY')) c.classList.remove('scale-[1.02]');
                    });
                    card.classList.add('ring-2', 'ring-indigo-500', 'scale-[1.02]');
                    
                    updateDetailPanel(item, data); // function below
                };

                dailyGrid.appendChild(card);

                // Auto Select Logic
                if(isToday) defaultCardToClick = card;
                else if(!defaultCardToClick && index === 0) defaultCardToClick = card;
            });

            // Summary Card (8th Slot)
            renderSummaryCard(data, dates, todayIso);

            // Trigger Default Click
            if(defaultCardToClick) defaultCardToClick.click();
        }

        // --- TOGGLE COMPLETE LOGIC ---
        window.toggleComplete = function(dateIso, checkbox) {
            saveCompletion(dateIso, checkbox.checked);
            // Re-render to update UI visuals (opacity etc.) or just toggle class for perf?
            // Simple re-render is safer for state sync
            const currentWeek = weekSelector.value;
            renderWeek(currentWeek);
        }

        // --- SUMMARY CARD ---
        function renderSummaryCard(data, dates, todayIso) {
            // Est volumes
            const dists = { "ë¦¬ì»¤ë²„ë¦¬": 5, "íœ´ì‹": 0, "í¬ë£¨ëŸ°": 6, "ì—…í": 5, "ì‰ì´í¬ì•„ì›ƒ": 4, "LSD": data.lsdDist };
            // Calc Total
            let weeklyTotal = 5 + 0 + 6 + 0 + 5 + 4 + data.lsdDist; 
            
            // Progress Bar
            let completedCount = 0;
            dates.forEach(d => {
                if(getStorageData()[d.iso]?.completed) completedCount++;
            });
            const progress = Math.round((completedCount / 7) * 100);

            const html = `
                <div class="bg-slate-800 dark:bg-slate-800/50 text-white rounded-xl p-4 shadow-lg flex flex-col justify-between relative overflow-hidden group border border-slate-700">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-500 opacity-10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                    <div>
                        <h4 class="font-bold text-sm text-slate-300 uppercase tracking-wide mb-4">Weekly Summary</h4>
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-3xl font-black text-indigo-400">${weeklyTotal.toFixed(1)}</span>
                            <span class="text-sm text-slate-400 mb-1">km Total</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>Progress</span>
                            <span>${completedCount}/7 Days</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
            dailyGrid.insertAdjacentHTML('beforeend', html);
        }

        // --- UPDATE DETAIL PANEL ---
        function updateDetailPanel(item, weekData) {
            const lib = workoutLibrary[item.type] || { why: "", how: "", caution: "" };
            
            // Update Text
            document.getElementById('detailTitle').textContent = item.type;
            document.getElementById('detailIcon').textContent = item.icon;
            document.getElementById('detailSpecs').textContent = `${item.work} (${item.detail})`;
            
            document.getElementById('detailWhy').textContent = lib.why;
            document.getElementById('detailHow').textContent = lib.how;
            document.getElementById('detailCaution').textContent = lib.caution;

            // Update Accent Color
            const accent = document.getElementById('detailAccent');
            if(item.type === 'LSD') accent.className = "absolute top-0 left-0 w-1.5 h-full bg-rose-500 transition-colors";
            else if(item.type === 'ì—…í') accent.className = "absolute top-0 left-0 w-1.5 h-full bg-indigo-500 transition-colors";
            else accent.className = "absolute top-0 left-0 w-1.5 h-full bg-slate-400 transition-colors";

            // Hide AI previous result
            document.getElementById('aiCoachArea').classList.add('hidden');
            
            // Update AI Context
            currentAiContext = {
                type: item.type,
                week: weekData.week,
                work: item.work,
                detail: item.detail,
                why: lib.why,
                user: "90kg, ì¢…ì•„ë¦¬ ë¶€ìƒ ì´ë ¥, ì•„í‚¤í…íŠ¸ ì„±í–¥"
            };
        }

        // --- AI API CALL ---
        const btnAskAI = document.getElementById('btnAskAI');
        const aiCoachArea = document.getElementById('aiCoachArea');
        const aiLoading = document.getElementById('aiLoading');
        const aiContent = document.getElementById('aiContent');
        const closeAi = document.getElementById('closeAi');

        btnAskAI.addEventListener('click', async () => {
            if(!apiKey) { alert("API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
            
            aiCoachArea.classList.remove('hidden');
            aiLoading.classList.remove('hidden');
            aiLoading.classList.add('flex');
            aiContent.innerHTML = "";

            const prompt = `
                ë‹¹ì‹ ì€ ì—˜ë¦¬íŠ¸ ëŸ¬ë‹ ì½”ì¹˜ì…ë‹ˆë‹¤. 
                ëŒ€ìƒ: ${currentAiContext.user}
                ì˜¤ëŠ˜ í›ˆë ¨: ${currentAiContext.type} (${currentAiContext.work})
                í›ˆë ¨ ëª©í‘œ: ${currentAiContext.why}
                
                ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì˜¤ëŠ˜ í›ˆë ¨ì„ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ **ì‹¤ì „ ê¿€íŒ(Pro Tip)**ì„ 1ê°€ì§€ ì•Œë ¤ì£¼ì„¸ìš”. 
                ë¶€ìƒ ë°©ì§€(íŠ¹íˆ ì¢…ì•„ë¦¬)ì™€ ë©˜íƒˆ ê´€ë¦¬ì— ì§‘ì¤‘í•´ì„œ, 3ë¬¸ì¥ ì´ë‚´ë¡œ í•µì‹¬ë§Œ ë§í•´ì£¼ì„¸ìš”.
                (ë§íˆ¬: ì „ë¬¸ì ì´ê³  ê°„ê²°í•˜ê²Œ, ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì‚¬ìš©)
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                const converter = new showdown.Converter();
                aiContent.innerHTML = converter.makeHtml(text);
            } catch (e) {
                aiContent.textContent = "AI ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                console.error(e);
            } finally {
                aiLoading.classList.add('hidden');
                aiLoading.classList.remove('flex');
            }
        });

        closeAi.addEventListener('click', () => aiCoachArea.classList.add('hidden'));

        // --- CALENDAR EXPORT (ICS) ---
        window.downloadICS = function() {
            const weekNum = weekSelector.value;
            const data = trainingData.find(d => d.week == weekNum);
            const dates = getWeekDates(data.date); // returns [{iso: '2025-11-17'...}, ...]
            
            // Basic VCALENDAR Structure
            let icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//BaeHaneul//RunPlan//KO
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
            
            const scheduleTypes = ["ë¦¬ì»¤ë²„ë¦¬", "íœ´ì‹", "í¬ë£¨ëŸ°", "íœ´ì‹", "ì—…í", "ì‰ì´í¬ì•„ì›ƒ", "LSD"];
            
            dates.forEach((d, idx) => {
                const type = scheduleTypes[idx];
                if(type === "íœ´ì‹") return; // Skip rest days

                const startDate = d.iso.replace(/-/g, ''); // YYYYMMDD
                // Set default time: Mon-Fri 19:00, Sat/Sun 07:00
                const isWeekend = (idx >= 5);
                const startTime = isWeekend ? "070000" : "190000";
                const endTime = isWeekend ? "090000" : "200000";

                icsContent += 
`BEGIN:VEVENT
SUMMARY:ğŸƒ [15ì£¼ í”Œëœ] ${type}
DTSTART:${startDate}T${startTime}
DTEND:${startDate}T${endTime}
DESCRIPTION:Week ${data.week} - ${type}. \\nëª©í‘œ: ${workoutLibrary[type].why}
STATUS:CONFIRMED
END:VEVENT
`;
            });

            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `Running_Plan_Week${data.week}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INIT ---
        weekSelector.addEventListener('change', (e) => renderWeek(e.target.value));
        
        // Auto select current week
        const today = new Date();
        const start = new Date(START_DATE);
        const diffTime = today - start;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        let currentWeek = 1;
        if(diffDays >= 0) currentWeek = Math.floor(diffDays / 7) + 1;
        if(currentWeek > 15) currentWeek = 15;
        
        weekSelector.value = currentWeek;
        renderWeek(currentWeek);

        // --- CHART RENDER (Moved to end) ---
        try {
            const ctx = document.getElementById('comboChart').getContext('2d');
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: trainingData.map(d => `W${d.week}`),
                    datasets: [
                        {
                            type: 'line',
                            label: 'ì—…í ì„¸íŠ¸',
                            data: trainingData.map(d => d.uphillSets),
                            borderColor: '#6366f1',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y1'
                        },
                        {
                            type: 'bar',
                            label: 'LSD ê±°ë¦¬',
                            data: trainingData.map(d => d.lsdDist),
                            backgroundColor: trainingData.map(d => d.week === 15 ? '#f43f5e' : (d.phase.includes('íšŒë³µ') ? '#94a3b8' : '#818cf8')),
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { display: false },
                        y1: { display: false, position: 'right' }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        } catch(e) {}

    </script>
</body>
</html>
