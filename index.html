<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°í•˜ëŠ˜ í•˜í”„ë§ˆë¼í†¤ : ì ì‘í˜• ìŠ¤ì¼€ì¤„ëŸ¬ V5.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .chart-container { position: relative; width: 100%; height: 350px; }
        
        /* Custom Checkbox */
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }

        /* Range Slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 3px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #475569;
        }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 300px;
            max-width: 90vw;
            margin-left: -150px;
            background-color: rgba(30, 41, 59, 0.95);
            color: #fff;
            text-align: left;
            border-radius: 12px;
            padding: 20px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.4s, bottom 0.4s;
            white-space: pre-wrap;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(8px);
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        .toast-title { font-weight: bold; font-size: 16px; margin-bottom: 8px; display: block; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px; }
        .toast-highlight { color: #818cf8; font-weight: bold; }
        .toast-warn { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-500 selection:text-white pb-20">

    <!-- NAV -->
    <nav class="bg-white dark:bg-slate-900 shadow-lg sticky top-0 z-50 border-b dark:border-slate-800 transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex flex-col">
                    <h1 class="text-xl md:text-2xl font-black tracking-tight text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="text-indigo-600 dark:text-indigo-400">ADAPTIVE</span> RUNNER V5.4
                    </h1>
                    <div id="dDayCounter" class="text-xs font-bold text-rose-500 bg-rose-50 dark:bg-rose-900/30 dark:text-rose-300 px-2 py-0.5 rounded w-fit mt-1">
                        D-DAY Loading...
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="resetPlan()" class="hidden md:flex text-xs text-slate-400 hover:text-red-500 underline mr-2">
                        âš ï¸ ì´ˆê¸°í™”
                    </button>
                    <button id="themeToggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                        ğŸŒ™
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">

        <!-- WEEK SELECTOR -->
        <section>
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        ğŸ“… ì£¼ê°„ í›ˆë ¨ ìŠ¤ì¼€ì¤„
                    </h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        ì¹´ë“œ ìš°ì¸¡ ìƒë‹¨ì˜ <span class="inline-flex items-center justify-center w-5 h-5 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded text-xs font-bold">â†º</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¤ì¼€ì¤„ì„ ë³€ê²½í•˜ê±°ë‚˜ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
                <div class="w-full md:w-64">
                    <select id="weekSelector" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none dark:bg-slate-800 transition">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <!-- STATUS BANNER -->
            <div id="phaseBanner" class="w-full px-4 py-3 rounded-lg mb-6 text-center font-bold text-sm shadow-sm transition-all"></div>

            <!-- DAILY GRID -->
            <div id="dailyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

            <!-- WORKOUT DETAIL PANEL -->
            <div id="workoutDetailPanel" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-lg relative overflow-hidden transition-all">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500 transition-colors" id="detailAccent"></div>
                <div class="ml-2">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-2">
                                <span id="detailIcon">ğŸƒ</span>
                                <span id="detailTitle">í›ˆë ¨ ê°€ì´ë“œ</span>
                            </h3>
                            <span id="detailSpecs" class="inline-block px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded font-mono text-sm">
                                ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">ğŸ¯ WHY (ëª©ì )</h4>
                            <p id="detailWhy" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">-</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">âš™ï¸ HOW (ì‹¤í–‰)</h4>
                            <p id="detailHow" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">-</p>
                        </div>
                        <div class="bg-rose-50 dark:bg-rose-900/20 p-5 rounded-xl border border-rose-100 dark:border-rose-900/50">
                            <h4 class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mb-3">âš ï¸ CAUTION (ì£¼ì˜)</h4>
                            <p id="detailCaution" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CHART SECTION -->
        <section>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">ğŸ“Š ì‹¤ì‹œê°„ ìŠ¤ì¼€ì¤„ ë³€ë™ ê·¸ë˜í”„</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">íšŒìƒ‰ ì ì„ (ì›ë˜ ê³„íš) vs ë§‰ëŒ€(ì¡°ì •ëœ í˜„ì¬ ê³„íš)</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="comboChart"></canvas>
                </div>
            </div>
        </section>

    </main>

    <!-- DAILY FEEDBACK MODAL -->
    <div id="dailyModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-t-2xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl border border-slate-200 dark:border-slate-700 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    âœ… í›ˆë ¨ ì™„ë£Œ í™•ì¸
                </h3>
                <span id="modalDate" class="text-xs font-mono text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">-</span>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold mb-3 text-slate-700 dark:text-slate-200">
                        ì˜¤ëŠ˜ ìš´ë™, ì–¼ë§ˆë‚˜ í˜ë“¤ì—ˆë‚˜ìš”?
                    </label>
                    <div class="relative pt-6 pb-2">
                        <input type="range" id="dailyRpeSlider" min="1" max="10" value="5" class="w-full">
                        <div class="flex justify-between mt-3 px-1">
                            <div class="text-center">
                                <span class="block text-xs text-slate-400">Easy</span>
                                <span class="block text-lg font-bold text-emerald-500">1</span>
                            </div>
                            <div class="text-center transform -translate-y-6">
                                <span id="dailyRpeValue" class="block text-3xl font-black text-indigo-600">5</span>
                                <span id="dailyRpeText" class="block text-xs font-bold text-indigo-500">ì ë‹¹í•¨</span>
                            </div>
                            <div class="text-center">
                                <span class="block text-xs text-slate-400">Max</span>
                                <span class="block text-lg font-bold text-rose-500">10</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800">
                    <p class="text-xs text-indigo-800 dark:text-indigo-300 leading-snug">
                        ğŸ’¡ <strong>ì ì‘í˜• ë¡œì§:</strong><br>
                        'ì˜¤ëŠ˜'ì˜ ê¸°ë¡ë§Œì´ ë¯¸ë˜ë¥¼ ë°”ê¿‰ë‹ˆë‹¤. ì§€ë‚˜ê°„ ë‚ ì§œì˜ ê¸°ë¡ì€ ê·¸ë˜í”„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeDailyModal()" class="flex-1 py-3 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-xl font-bold text-sm hover:bg-slate-200 transition">ì·¨ì†Œ</button>
                    <button onclick="saveDailyFeedback()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg transition transform active:scale-95">ì €ì¥ ë° ìŠ¤ì¼€ì¤„ ì¡°ì •</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MISSED WORKOUTS MODAL -->
    <div id="missedModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl border border-slate-200 dark:border-slate-700 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">â†º í›ˆë ¨ ë³€ê²½í•˜ê¸°</h3>
                <button onclick="closeMissedModal()" class="text-slate-400 hover:text-slate-600">âœ•</button>
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">
                ì„ íƒí•œ ë‚ ì§œ(<span id="missedTargetDate" class="font-mono text-indigo-500 font-bold"></span>)ë¥¼<br>
                ì•„ë˜ í›ˆë ¨ ì¤‘ í•˜ë‚˜ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
            </p>
            <div id="missedList" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                <!-- Items populated via JS -->
            </div>
        </div>
    </div>

    <!-- TOAST MSG -->
    <div id="toast">ë©”ì‹œì§€</div>

    <!-- SCRIPT -->
    <script>
        // --- CONSTANTS ---
        const STORAGE_KEY = "adaptive_plan_v5_4_data";
        const START_DATE = "2025-11-17"; 
        
        // --- MASTER PLAN ---
        const MASTER_PLAN = [
            { week: 1, phase: "ì ì‘ê¸°", note: "ì ì‘ ì‹œì‘", lsdDist: 14.00, uphillSets: 8 },
            { week: 2, phase: "ì ì‘ê¸°", note: "ê±°ë¦¬ ì¦ê°€", lsdDist: 15.40, uphillSets: 9 },
            { week: 3, phase: "ì ì‘ê¸°", note: "ê¸°ì´ˆ ì²´ë ¥", lsdDist: 16.94, uphillSets: 10 },
            { week: 4, phase: "íšŒë³µì£¼", note: "ê°•ë„ ì¡°ì ˆ", lsdDist: 11.86, uphillSets: 7 },
            { week: 5, phase: "ê°•í™”ê¸°", note: "ë¹Œë“œì—… 1", lsdDist: 16.94, uphillSets: 10 },
            { week: 6, phase: "ê°•í™”ê¸°", note: "ë¹Œë“œì—… 2", lsdDist: 18.63, uphillSets: 11 },
            { week: 7, phase: "ê°•í™”ê¸°", note: "20K ëŒíŒŒ", lsdDist: 20.50, uphillSets: 12 },
            { week: 8, phase: "íšŒë³µì£¼", note: "ì¤‘ê°„ íœ´ì‹", lsdDist: 14.35, uphillSets: 7 },
            { week: 9, phase: "ê°•í™”ê¸°", note: "ê³ ê°•ë„", lsdDist: 20.50, uphillSets: 12 },
            { week: 10, phase: "ê°•í™”ê¸°", note: "í”¼í¬ ì¤€ë¹„", lsdDist: 22.55, uphillSets: 13 },
            { week: 11, phase: "ê°•í™”ê¸°", note: "MAX PEAK", lsdDist: 24.80, uphillSets: 14 },
            { week: 12, phase: "ì¡°ì ˆê¸°", note: "í…Œì´í¼ë§", lsdDist: 17.36, uphillSets: 9 },
            { week: 13, phase: "ì‹¤ì „ê¸°", note: "í˜ì´ìŠ¤", lsdDist: 19.84, uphillSets: 11 },
            { week: 14, phase: "ì¡°ì ˆê¸°", note: "íœ´ì‹ í™•ë³´", lsdDist: 14.88, uphillSets: 9 },
            { week: 15, phase: "ëŒ€íšŒì£¼", note: "D-DAY", lsdDist: 7.44, uphillSets: 4 }
        ];

        const SCHEDULE_TEMPLATE = [
            { day: "ì›”", type: "ë¦¬ì»¤ë²„ë¦¬", icon: "ğŸ›Œ", work: "íšŒë³µ ì¡°ê¹… 5km", detail: "Zone 1-2" },
            { day: "í™”", type: "íœ´ì‹", icon: "ğŸ§˜", work: "ì™„ì „ íœ´ì‹", detail: "ìŠ¤íŠ¸ë ˆì¹­" },
            { day: "ìˆ˜", type: "í¬ë£¨ëŸ°", icon: "ğŸƒâ€â™‚ï¸", work: "í¬ë£¨ ëŸ¬ë‹ 6km", detail: "Fun Run" },
            { day: "ëª©", type: "íœ´ì‹", icon: "ğŸ§˜", work: "ì™„ì „ íœ´ì‹", detail: "ìˆ˜ë©´ ë³´ì¶©" },
            { day: "ê¸ˆ", type: "ì—…í", icon: "â›°ï¸", work: "ì—…í SETS", detail: "ë‚´ë¦¬ë§‰ ê±·ê¸°" },
            { day: "í† ", type: "ì‰ì´í¬ì•„ì›ƒ", icon: "ğŸƒ", work: "ì¡°ê¹… 4km", detail: "ì§ˆì£¼ 2íšŒ" },
            { day: "ì¼", type: "LSD", icon: "ğŸ›£ï¸", work: "ì¥ê±°ë¦¬ì£¼ DIST", detail: "ì¼ì • í˜ì´ìŠ¤" }
        ];

        // --- STATE ---
        let completionData = {}; 
        let calculatedPlan = [];
        let swappedWorkouts = {}; 
        let selectedDate = new Date().toISOString().split('T')[0]; // Default to today

        // --- HELPERS ---
        function getTodayIso() {
            return new Date().toISOString().split('T')[0];
        }

        function getWeekDates(startDateStr) {
            const startDate = new Date(startDateStr);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                dates.push({ display: `${d.getMonth()+1}.${d.getDate()}`, iso: iso, obj: d });
            }
            return dates;
        }

        function getWeekStartDate(weekNum) {
            const start = new Date(START_DATE);
            start.setDate(start.getDate() + (weekNum - 1) * 7);
            return start.toISOString().split('T')[0];
        }

        function getWeekNumFromDate(isoDate) {
            const start = new Date(START_DATE);
            const current = new Date(isoDate);
            const diffDays = Math.floor((current - start) / (86400000));
            return Math.floor(diffDays / 7) + 1;
        }

        // --- CORE ALGORITHM ---
        function recalculatePlan() {
            let tempPlan = JSON.parse(JSON.stringify(MASTER_PLAN));
            const dates = Object.keys(completionData).sort();
            const todayIso = getTodayIso();

            dates.forEach(date => {
                const record = completionData[date];
                if (!record.completed) return;
                
                if (date < todayIso) return; 

                const weekNum = getWeekNumFromDate(date);
                const rpe = record.rpe;
                
                let multiplier = 1.0;
                
                if (rpe >= 9) multiplier = 0.90; 
                else if (rpe >= 8) multiplier = 0.95; 
                else if (rpe <= 2) multiplier = 1.02; 
                
                if (multiplier !== 1.0) {
                    for (let w = weekNum; w < 15; w++) {
                        if (tempPlan[w]) {
                            tempPlan[w].lsdDist = parseFloat((tempPlan[w].lsdDist * multiplier).toFixed(2));
                            tempPlan[w].uphillSets = Math.max(1, Math.round(tempPlan[w].uphillSets * multiplier));
                        }
                    }
                }
            });

            return tempPlan;
        }

        // --- LOAD & SAVE ---
        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                completionData = parsed.completionData || {};
                swappedWorkouts = parsed.swappedWorkouts || {};
            }
            calculatedPlan = recalculatePlan(); 
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ completionData, swappedWorkouts }));
            calculatedPlan = recalculatePlan(); 
            updateChart();
            renderWeek(document.getElementById('weekSelector').value);
        }

        function resetPlan() {
            if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- RENDER WEEK ---
        function initDropdown() {
            const selector = document.getElementById('weekSelector');
            selector.innerHTML = "";
            MASTER_PLAN.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.week;
                opt.text = `Week ${d.week} (${d.phase})`;
                selector.appendChild(opt);
            });
        }

        function selectCard(iso, item) {
            selectedDate = iso;
            updateDetail(item);
            renderWeek(document.getElementById('weekSelector').value); // Re-render to update highlight
        }

        function renderWeek(weekNum) {
            const plan = calculatedPlan.find(d => d.week == weekNum);
            const master = MASTER_PLAN.find(d => d.week == weekNum);
            const startDate = getWeekStartDate(weekNum);
            const dates = getWeekDates(startDate);
            const todayIso = getTodayIso();

            // Banner
            const diff = plan.lsdDist - master.lsdDist;
            let bannerHtml = `Week ${plan.week} [${plan.phase}]`;
            if (Math.abs(diff) > 0.1) {
                const color = diff < 0 ? "text-rose-600 dark:text-rose-400" : "text-emerald-600 dark:text-emerald-400";
                const icon = diff < 0 ? "ğŸ“‰ í•˜í–¥" : "ğŸ“ˆ ìƒí–¥";
                bannerHtml += ` <span class="ml-2 text-xs font-bold ${color}">(${icon} ${diff > 0 ? '+' : ''}${diff.toFixed(1)}km)</span>`;
            } else {
                bannerHtml += ` <span class="ml-2 text-xs text-slate-400">(Standard)</span>`;
            }
            document.getElementById('phaseBanner').innerHTML = bannerHtml;

            // Grid
            const grid = document.getElementById('dailyGrid');
            grid.innerHTML = '';

            let scheduleTemplate = SCHEDULE_TEMPLATE.map(t => ({...t})); 
            scheduleTemplate[4].work = `ì—…í ${plan.uphillSets}ì„¸íŠ¸`;
            scheduleTemplate[6].work = `ì¥ê±°ë¦¬ì£¼ ${plan.lsdDist.toFixed(1)}km`;

            scheduleTemplate.forEach((templateItem, index) => {
                const dateInfo = dates[index];
                const isToday = (dateInfo.iso === todayIso);
                const isSelected = (dateInfo.iso === selectedDate);
                const record = completionData[dateInfo.iso];
                const isCompleted = record && record.completed;
                
                // Swap Logic
                let item = { ...templateItem };
                if (swappedWorkouts[dateInfo.iso]) {
                    item = JSON.parse(JSON.stringify(swappedWorkouts[dateInfo.iso]));
                    item.day = templateItem.day;
                }

                // Handlers
                const clickHandler = `handleCardClick('${dateInfo.iso}', '${item.type}')`;
                const swapHandler = `openMissedModal('${dateInfo.iso}')`;
                const restoreHandler = `restoreWorkout('${dateInfo.iso}')`;

                const div = document.createElement('div');
                let divClass = "relative rounded-xl p-4 shadow-sm border transition-all duration-200 cursor-pointer group ";
                
                // Base Style
                if (isCompleted) divClass += "bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800 ";
                else divClass += "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:-translate-y-1 ";

                // Selection Highlight (The Ring)
                if (isSelected) {
                    divClass += "ring-2 ring-indigo-500 scale-[1.02] z-10 ";
                }

                div.className = divClass;
                
                // Content construction
                let swapBtn = "";
                let customBadge = "";
                
                if (swappedWorkouts[dateInfo.iso]) {
                    customBadge = `<span class="block text-[10px] text-amber-600 font-bold mb-1">â†º ë³€ê²½ë¨</span>`;
                    if (!isCompleted) {
                        swapBtn = `<button onclick="event.stopPropagation(); ${restoreHandler}" class="w-12 h-6 flex items-center justify-center bg-amber-100 text-amber-700 rounded text-[10px] font-bold hover:bg-amber-200 transition" title="ì›ë˜ëŒ€ë¡œ ë³µêµ¬">â†º ë³µêµ¬</button>`;
                    }
                } else {
                    if (!isCompleted) {
                        swapBtn = `<button onclick="event.stopPropagation(); ${swapHandler}" class="w-6 h-6 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded text-slate-500 hover:bg-indigo-100 hover:text-indigo-600 transition" title="í›ˆë ¨ ë³€ê²½">â†º</button>`;
                    }
                }

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex flex-col">
                            <div>
                                <span class="text-xs font-bold ${isSelected ? 'text-indigo-600' : 'text-slate-500'}">${dateInfo.display} (${item.day})</span>
                                ${isToday ? '<span class="ml-2 text-[10px] bg-slate-800 text-white px-1.5 py-0.5 rounded-full">TODAY</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            ${swapBtn}
                            <div class="checkbox-wrapper" onclick="event.stopPropagation(); ${clickHandler}">
                                <label class="cursor-pointer flex items-center">
                                    <input type="checkbox" class="peer sr-only" ${isCompleted ? 'checked' : ''}>
                                    <div class="w-6 h-6 border-2 border-slate-300 dark:border-slate-500 rounded flex items-center justify-center peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition-colors">
                                        <svg class="w-3.5 h-3.5 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    ${customBadge}
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-lg">${item.icon}</span>
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm">${item.type}</h4>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">${item.work}</p>
                    
                    ${isCompleted ? 
                        `<div class="flex items-center gap-1">
                            <span class="text-[10px] bg-emerald-100 dark:bg-emerald-800 text-emerald-700 dark:text-emerald-200 px-1.5 py-0.5 rounded font-bold">RPE ${record.rpe}</span>
                         </div>` 
                        : 
                        `<span class="text-[10px] bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 font-mono">${item.detail}</span>`
                    }
                `;
                
                // CLICK SELECT
                // Note: We pass properties of 'item' to create a plain object for the handler
                const itemData = { type: item.type, icon: item.icon, work: item.work, detail: item.detail };
                div.onclick = () => selectCard(dateInfo.iso, itemData);
                grid.appendChild(div);

                if (isSelected) updateDetail(item);
            });
        }

        function updateDetail(item) {
            const workoutLibrary = {
                "ë¦¬ì»¤ë²„ë¦¬": { why: "í”¼ë¡œ ë¬¼ì§ˆ ì œê±°", how: "ì˜† ì‚¬ëŒê³¼ ëŒ€í™” ê°€ëŠ¥í•  ì •ë„ë¡œ ì²œì²œíˆ", caution: "ì†ë„ ìš•ì‹¬ ê¸ˆì§€" },
                "íœ´ì‹": { why: "ê·¼ìœ¡ ì„±ì¥ ë° ì¬ì¶©ì „", how: "ì™„ì „ íœ´ì‹", caution: "ë³´ê°•ìš´ë™ë„ ê¸ˆì§€" },
                "í¬ë£¨ëŸ°": { why: "ëŸ¬ë‹ ì¦ê±°ì›€ ìœ ì§€", how: "ë™ë£Œë“¤ê³¼ í¸ì•ˆí•œ í˜ì´ìŠ¤", caution: "ì˜¤ë²„í˜ì´ìŠ¤ ì£¼ì˜" },
                "ì—…í": { why: "ì‹¬íì§€êµ¬ë ¥/íŒŒì›Œ ê°•í™”", how: "ì˜¤ë¥´ë§‰ ì§§ê²Œ/ë‚´ë¦¬ë§‰ ê±·ê¸°", caution: "ë‚´ë¦¬ë§‰ ë›°ê¸° ê¸ˆì§€" },
                "ì‰ì´í¬ì•„ì›ƒ": { why: "ì»¨ë””ì…˜ ì ê²€", how: "ê°€ë³ê²Œ ì¡°ê¹… + ì§ˆì£¼", caution: "ì—ë„ˆì§€ ë¹„ì¶•" },
                "LSD": { why: "ì§€ë°© ëŒ€ì‚¬ íš¨ìœ¨ ì¦ëŒ€", how: "ì¼ì • í˜ì´ìŠ¤ ì™„ì£¼", caution: "ì´ˆë°˜ ì˜¤ë²„í˜ì´ìŠ¤ ì£¼ì˜" }
            };
            const lib = workoutLibrary[item.type] || { why: "-", how: "-", caution: "-" };
            
            document.getElementById('detailTitle').textContent = item.type;
            document.getElementById('detailIcon').textContent = item.icon;
            document.getElementById('detailSpecs').textContent = `${item.work} (${item.detail})`;
            document.getElementById('detailWhy').textContent = lib.why;
            document.getElementById('detailHow').textContent = lib.how;
            document.getElementById('detailCaution').textContent = lib.caution;

            const accent = document.getElementById('detailAccent');
            if (item.type === 'LSD') accent.className = "absolute top-0 left-0 w-1.5 h-full bg-rose-500 transition-colors";
            else if (item.type === 'ì—…í') accent.className = "absolute top-0 left-0 w-1.5 h-full bg-indigo-500 transition-colors";
            else accent.className = "absolute top-0 left-0 w-1.5 h-full bg-slate-400 transition-colors";
        }

        // --- MISSED WORKOUT LOGIC ---
        let targetSwapDate = null; 

        function openMissedModal(targetDate) {
            targetSwapDate = targetDate;
            document.getElementById('missedTargetDate').textContent = targetDate;
            
            const list = document.getElementById('missedList');
            list.innerHTML = "";
            const todayIso = getTodayIso();
            const start = new Date(START_DATE);
            const today = new Date();
            
            let missedItems = [];

            for (let d = new Date(start); d < today; d.setDate(d.getDate() + 1)) {
                const iso = d.toISOString().split('T')[0];
                if (iso === todayIso) continue; 

                if (!completionData[iso] || !completionData[iso].completed) {
                    const weekNum = getWeekNumFromDate(iso);
                    const plan = calculatedPlan.find(p => p.week == weekNum);
                    
                    const dayIdx = (d.getDay() + 6) % 7; 
                    const template = SCHEDULE_TEMPLATE[dayIdx];
                    
                    if (template.type === "íœ´ì‹") continue;

                    let workStr = template.work;
                    if (template.type === "ì—…í") workStr = `ì—…í ${plan.uphillSets}ì„¸íŠ¸`;
                    if (template.type === "LSD") workStr = `ì¥ê±°ë¦¬ì£¼ ${plan.lsdDist.toFixed(1)}km`;

                    let tag = "";
                    let itemClass = "border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50";
                    
                    if (["ë¦¬ì»¤ë²„ë¦¬", "ì‰ì´í¬ì•„ì›ƒ", "í¬ë£¨ëŸ°"].includes(template.type)) {
                        tag = `<span class="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold">âœ¨ ì¶”ì²œ</span>`;
                        itemClass = "border-emerald-200 bg-emerald-50/50 hover:bg-emerald-50 dark:border-emerald-900 dark:bg-emerald-900/10";
                    } else {
                        tag = `<span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold">âš ï¸ ì£¼ì˜</span>`;
                    }

                    missedItems.push({ iso, weekNum, template, workStr, tag, itemClass });
                }
            }

            missedItems.reverse(); 

            if (missedItems.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400">ë†“ì¹œ í›ˆë ¨ì´ ì—†ìŠµë‹ˆë‹¤!</div>`;
            } else {
                missedItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg border cursor-pointer transition flex justify-between items-center ${item.itemClass}`;
                    div.onclick = () => selectMissedWorkout(item.iso, item.template, item.workStr);
                    div.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs text-slate-500 font-mono">${item.iso}</span>
                                ${item.tag}
                            </div>
                            <div class="flex items-center gap-2">
                                <span>${item.template.icon}</span>
                                <span class="font-bold text-sm text-slate-800 dark:text-slate-200">${item.template.type}</span>
                                <span class="text-xs text-slate-500">- ${item.workStr}</span>
                            </div>
                        </div>
                        <span class="text-indigo-600 text-sm font-bold">ì„ íƒ &rarr;</span>
                    `;
                    list.appendChild(div);
                });
            }

            document.getElementById('missedModal').classList.remove('hidden');
        }

        function closeMissedModal() {
            document.getElementById('missedModal').classList.add('hidden');
        }

        function selectMissedWorkout(originalDate, template, workStr) {
            // NO CONFIRM DIALOG - Immediate Action
            const newWorkout = JSON.parse(JSON.stringify(template));
            newWorkout.work = workStr; 
            
            swappedWorkouts[targetSwapDate] = newWorkout;
            
            saveData(); 
            closeMissedModal();
            showToast("í›ˆë ¨ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function restoreWorkout(targetDate) {
            // FIXED: Directly delete and save
            delete swappedWorkouts[targetDate];
            saveData();
            showToast("ìŠ¤ì¼€ì¤„ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // --- FEEDBACK & OTHER LOGIC ---
        let currentModalDate = null;
        let currentModalType = null;

        function handleCardClick(isoDate, type) {
            const record = completionData[isoDate];
            if (record && record.completed) {
                if(confirm("ê¸°ë¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    delete completionData[isoDate];
                    saveData();
                    showToast("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                currentModalDate = isoDate;
                currentModalType = type;
                document.getElementById('modalDate').innerText = isoDate;
                document.getElementById('dailyRpeSlider').value = 5;
                updateSliderUI(5);
                document.getElementById('dailyModal').classList.remove('hidden');
            }
        }

        function closeDailyModal() {
            document.getElementById('dailyModal').classList.add('hidden');
        }

        function saveDailyFeedback() {
            const rpe = parseInt(document.getElementById('dailyRpeSlider').value);
            const weekNum = getWeekNumFromDate(currentModalDate);
            const targetIndex = weekNum; 
            let oldLsd = calculatedPlan[targetIndex] ? calculatedPlan[targetIndex].lsdDist : 0;

            completionData[currentModalDate] = { completed: true, rpe: rpe, type: currentModalType };
            saveData();

            let newLsd = calculatedPlan[targetIndex] ? calculatedPlan[targetIndex].lsdDist : 0;
            
            let msg = `<span class="toast-title">âœ… ì €ì¥ ì™„ë£Œ</span>`;
            if (currentModalDate < getTodayIso()) {
                msg += `ê³¼ê±° ë‚ ì§œ ê¸°ë¡ì…ë‹ˆë‹¤. ë¯¸ë˜ ìŠ¤ì¼€ì¤„ì€ ë³€ë™ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
            } else {
                if (oldLsd !== newLsd) {
                    const diff = newLsd - oldLsd;
                    const color = diff > 0 ? "toast-highlight" : "toast-warn";
                    msg += `ë‹¤ìŒ ì£¼ LSD: ${oldLsd} â†’ <span class="${color}">${newLsd}km</span>\n`;
                } else {
                    msg += `ìŠ¤ì¼€ì¤„ ìœ ì§€ë¨. (RPE ${rpe})`;
                }
            }
            showToast(msg);
            closeDailyModal();
        }

        const slider = document.getElementById('dailyRpeSlider');
        slider.oninput = function() { updateSliderUI(this.value); }
        function updateSliderUI(val) {
            document.getElementById('dailyRpeValue').innerText = val;
            let text = "ë³´í†µ"; let color = "text-indigo-500";
            if(val<=2){text="ë§¤ìš° ì‰¬ì›€";color="text-emerald-500";}
            else if(val<=4){text="ì‰¬ì›€";color="text-emerald-600";}
            else if(val<=6){text="ì ë‹¹í•¨";color="text-indigo-500";}
            else if(val<=8){text="í˜ë“¦";color="text-amber-500";}
            else{text="ê·¹í•œ";color="text-rose-600";}
            document.getElementById('dailyRpeText').innerText=text;
            document.getElementById('dailyRpeText').className=`block text-xs font-bold ${color}`;
        }

        let toastTimeout;
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerHTML = msg; 
            toast.className = "show";
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 4000);
        }

        let myChart;
        function updateChart() {
            const ctx = document.getElementById('comboChart').getContext('2d');
            const labels = calculatedPlan.map(d => `W${d.week}`);
            const originalData = MASTER_PLAN.map(d => d.lsdDist);
            const currentData = calculatedPlan.map(d => d.lsdDist);
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { type: 'line', label: 'ì›ë˜ ê³„íš', data: originalData, borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, order: 1 },
                        { type: 'bar', label: 'í˜„ì¬ ê³„íš', data: currentData, backgroundColor: calculatedPlan.map(d => d.week==document.getElementById('weekSelector').value?'#4f46e5':'#818cf8'), order: 2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false } } }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            initDropdown();
            
            const today = new Date();
            const start = new Date(START_DATE);
            const diffDays = Math.floor((today - start) / (86400000));
            let week = Math.floor(diffDays / 7) + 1;
            if(week < 1) week = 1; if(week > 15) week = 15;
            
            const selector = document.getElementById('weekSelector');
            selector.value = week;
            selector.addEventListener('change', (e) => renderWeek(e.target.value));
            
            const raceDay = new Date("2026-03-01");
            const dDiff = Math.ceil((raceDay - today) / (86400000));
            document.getElementById('dDayCounter').textContent = `D-${dDiff}`;
            document.getElementById('themeToggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); });

            renderWeek(week);
            updateChart();
        });
    </script>
</body>
</html>
